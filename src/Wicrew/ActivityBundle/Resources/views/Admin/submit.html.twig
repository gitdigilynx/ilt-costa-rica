<script type="text/javascript">
    jQuery(document).ready(function () {
        const PER_PERSON = "{{ constant('App\\Wicrew\\CoreBundle\\Entity\\IBasePriceEntity::PRICE_TYPE_PER_PERSON') }}";
        const FIXED_PRICE = "{{ constant('App\\Wicrew\\CoreBundle\\Entity\\IBasePriceEntity::PRICE_TYPE_FOR_THE_TRIP') }}";

        function toggleFields() {
            let actMainPriceElm = jQuery("#activity_adultRackPrice").parents('.field-group:first');
            let childCollections = jQuery("#activity_childs").parents(".field-collection:first");

            if (jQuery("#activity_combo").is(":checked")) {
                childCollections.parents('.activity-childs').addClass('required-collection');
                $('#activity_priceType').parent().parent().hide();

                showActivityPricingFields(['adultRackPrice','childRackPrice']);
                hideActivityPricingFields(['adultNetPrice','childNetPrice','fixedNetPrice','fixedRackPrice']);

                $('.activity-childs').parent().parent().parent().show();
            } else {
                childCollections.parents('.activity-childs').removeClass('required-collection');
                $('#activity_priceType').parent().parent().show();

                showActivityPricingFields(['adultRackPrice','adultNetPrice','childRackPrice','childNetPrice']);
                hideActivityPricingFields(['fixedRackPrice','fixedNetPrice']);

                $('.activity-childs').parent().parent().parent().hide();
            }

            if (jQuery("#activity_transportationRequired").is(":checked")) {
                jQuery("#activity_transportAdultRackPrice").parents(".form-group:eq(0)").show();
                jQuery("#activity_transportAdultNetPrice").parents(".form-group:eq(0)").show();
                jQuery("#activity_transportKidRackPrice").parents(".form-group:eq(0)").show();
                jQuery("#activity_transportKidNetPrice").parents(".form-group:eq(0)").show();
                jQuery("#activity_transportationTax").parents(".form-group:eq(0)").show();
            } else {
                jQuery("#activity_transportAdultRackPrice").parents(".form-group:eq(0)").hide();
                jQuery("#activity_transportAdultNetPrice").parents(".form-group:eq(0)").hide();
                jQuery("#activity_transportKidRackPrice").parents(".form-group:eq(0)").hide();
                jQuery("#activity_transportKidNetPrice").parents(".form-group:eq(0)").hide();
                jQuery("#activity_transportationTax").parents(".form-group:eq(0)").hide();
            }
        }

        toggleFields();

        jQuery("#activity_combo, #activity_transportationRequired").change(function () {
            toggleFields();
        });

        jQuery('.validate-form').submit(function (e) {
            let error = validateForm();
            if (error) {
                setTimeout(function () {
                    jQuery('button.action-save').removeAttr('disabled');
                }, 100);

                return false;
            }
        });

        function updatePriceTypeVisibility(selectInput) {
            if (jQuery("#activity_combo").is(":checked")) return;

            if (selectInput.val() === PER_PERSON) {
                showActivityPricingFields(['adultRackPrice','adultNetPrice','childRackPrice','childNetPrice']);
                hideActivityPricingFields(['fixedRackPrice','fixedNetPrice']);
            } else if (selectInput.val() === FIXED_PRICE) {
                showActivityPricingFields(['fixedRackPrice','fixedNetPrice']);
                hideActivityPricingFields(['adultRackPrice','adultNetPrice','childRackPrice','childNetPrice']);
            }
        }

        $("#activity_priceType").each(function () {
            $(this).on("change", function () {
                updatePriceTypeVisibility($(this));
            });
            updatePriceTypeVisibility($(this));
        });

        function updatePriceTypeRowForChild(selectInput) {
            let row = selectInput.parents('[id^="activity_childs_"]');

            if (selectInput.val() === PER_PERSON) {
                row.find('input[id$="_adultRackPrice"]').removeAttr("readonly");
                row.find('input[id$="_adultNetPrice"]').removeAttr("readonly");
                row.find('input[id$="_childRackPrice"]').removeAttr("readonly");
                row.find('input[id$="_childNetPrice"]').removeAttr("readonly");
                row.find('input[id$="_fixedRackPrice"]').attr("readonly", "readonly");
                row.find('input[id$="_fixedNetPrice"]').attr("readonly", "readonly");
            } else if (selectInput.val() === FIXED_PRICE) {
                row.find('input[id$="_adultRackPrice"]').attr("readonly", "readonly");
                row.find('input[id$="_adultNetPrice"]').attr("readonly", "readonly");
                row.find('input[id$="_childRackPrice"]').attr("readonly", "readonly");
                row.find('input[id$="_childNetPrice"]').attr("readonly", "readonly");
                row.find('input[id$="_fixedRackPrice"]').removeAttr("readonly");
                row.find('input[id$="_fixedNetPrice"]').removeAttr("readonly");
            }
        }

        $('.activity-childs select[id$="_priceType"]').each(function () {
            $(this).on("change", function () {
                updatePriceTypeRowForChild($(this));
            });
            updatePriceTypeRowForChild($(this));
        });

        /*
        we calculate the AdultNetPrice, ChildNetPrice, FixedNetPrice from the sum in the activities table in the 'Suppliers Details' tab
        */
        handleChangeNetPrice();

        /*
        if 'Per person' : 'Net rate per adult' and 'Net rate per child' required, 'Net fixed rate' optionnal
        if 'Fixed price' : 'Net rate per adult' and 'Net rate per child' optionnal, 'Net fixed rate' required
        */
        handleRequiredFieldActivityChild();

        function handleChangeNetPrice() {
            if ($("#activity_combo").is(":checked")) {
                updateFieldNetPrice(['adult', 'child', 'fixed']);
            }
            $("#activity_combo").on('change', function() {
                if ($("#activity_combo").is(":checked")) {
                    updateFieldNetPrice(['adult', 'child', 'fixed']);
                }
            });

            handleChangeNetPriceChild();
            $(".collection-add").on('wi_activity_child_added', function() {
                handleChangeNetPriceChild();
            })
        }

        function handleChangeNetPriceChild() {
            $('#activity_childs input').on('keyup', function() {
                updateFieldNetPrice(['adult', 'child', 'fixed']);
            });
            $('#activity_childs select').on('change', function() {
                updateFieldNetPrice(['adult', 'child', 'fixed']);
            });
            $('#activity_childs .collection-remove').on('click', function() {
                updateFieldNetPrice(['adult', 'child', 'fixed']);
            });
        }

        function handleRequiredFieldActivityChild() {
            handleChangeRequiredFieldActivityChild();
            $(".collection-add").on('wi_activity_child_added', function() {
                handleChangeRequiredFieldActivityChild();
            });
        }

        function handleChangeRequiredFieldActivityChild() {
            updateRequiredFieldActivityChild();
            $("[id^='activity_childs_'][id$='_priceType']").on('change', function() {
                updateRequiredFieldActivityChild();
            });
        }

        function get_activity_number() {
            let activity_number = [];
            $('[id^="activity_childs_"][id$="priceType"]').each(function() {
                number = $(this).attr('id').replace('activity_childs_', '').replace('_priceType', '');
                number = parseInt(number);
                activity_number.push(number);
            });
            return activity_number;
        }

        function updateRequiredFieldActivityChild() {
            let activity_number = get_activity_number();

            for(let k=0;k<activity_number.length;k++) {
                i = activity_number[k];
                let price_type = $('#activity_childs_'+i+'_priceType').val();
                $net_rate_adult_child = $('#activity_childs_'+i+'_adultNetPrice, #activity_childs_'+i+'_childNetPrice');
                $net_fixed_rate = $('#activity_childs_'+i+'_fixedNetPrice');
                if (price_type == PER_PERSON) {
                    $net_rate_adult_child
                        .attr('required', 'required')
                        .removeAttr('readonly')
                    ;
                    $net_fixed_rate
                        .removeAttr('required')
                        .attr('readonly', 'readonly')
                        .val('0')
                    ;
                } else if (price_type == FIXED_PRICE) {
                    $net_fixed_rate
                        .attr('required', 'required')
                        .removeAttr('readonly')
                    ;
                    $net_rate_adult_child
                        .removeAttr('required')
                        .attr('readonly', 'readonly')
                        .val('0')
                    ;
                }
            }
        }

        /*
           we just want to update the net price fields from the field in the activities table in the 'suppliers details' tab to the net price fields in the 'general' tab
            field_types contains 'adult' or 'child' or 'fixed'
            targeted ids are :
                activity_adultNetPrice
                activity_childNetPrice
                activity_fixedNetPrice
                activity[childs][x][adultNetPrice]
                activity[childs][x][childNetPrice]
                activity[childs][x][fixedNetPrice]
        */
        function updateFieldNetPrice(field_types) {
            for(let j = 0; j<field_types.length;j++) {
                field_type = field_types[j];
                let netPrice = 0;
                let activity_number = get_activity_number();

                for(let k=0;k<activity_number.length;k++) {
                    i = activity_number[k];
                    $child = $('[name="activity\[childs\]\['+i+'\]\['+field_type+'NetPrice\]"]');
                    let price_type = $('#activity_childs_'+i+'_priceType').val();
                    let addPrice =
                        (['adult', 'child'].includes(field_type) && price_type == PER_PERSON) ||
                        (['fixed'].includes(field_type) && price_type == FIXED_PRICE)
                    ;

                    if (addPrice) {
                        netPriceChild = ($child.val()) ? $child.val() : 0;
                        netPrice += parseFloat(netPriceChild);
                    }
                }

                $('#activity_'+field_type+'NetPrice').val(netPrice);
            }
        }

        function hideActivityPricingFields(id_fields) {
            let activity_pricing_row = $("#activity_priceType").parents("fieldset");
            for(let i=0; i<id_fields.length;i++) {
                let id_field = id_fields[i];
                activity_pricing_row.find('input[id$="_'+id_field+'"]').closest(".col-12").attr("hidden", "hidden");
            }
        }

        function showActivityPricingFields(id_fields) {
            let activity_pricing_row = $("#activity_priceType").parents("fieldset");
            for(let i=0; i<id_fields.length;i++) {
                let id_field = id_fields[i];
                activity_pricing_row.find('input[id$="_'+id_field+'"]').closest(".col-12").removeAttr("hidden");
            }
        }

    });
</script>
