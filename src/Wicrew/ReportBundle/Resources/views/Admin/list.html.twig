{% extends "@EasyAdmin/default/list.html.twig" %}

{% block global_actions %}
    {{ parent() }}

    <div class="button-action">
        <a class="btn btn-info action-export"
           href="{{ path('easyadmin', _request_parameters|merge({ action: 'export' })) }}" target="_blank">
            <i class="fa fa-fw fa-file-excel"></i>{{ "report.export"|trans }}
        </a>
    </div>
{% endblock %}

{% block main %}
    {% set _fields_visible_by_user = fields|filter((metadata, field) => easyadmin_is_granted(metadata.permission)) %}
    {% set _number_of_hidden_results = 0 %}
    {% set _list_item_actions = easyadmin_get_actions_for_list_item(_entity_config.name) %}

    <table class="table datagrid">
        <thead>
        {% block table_head %}
            <tr>
                {% if _has_batch_actions %}
                    <th width="1px"><span><input type="checkbox" class="form-batch-checkbox-all"></span></th>
                {% endif %}

                {% for field, metadata in _fields_visible_by_user %}
                    {% set isSortingField = (metadata.property == app.request.get('sortField')) or ('association' == metadata.type and app.request.get('sortField') starts with metadata.property ~ '.') %}
                    {% set nextSortDirection = isSortingField ? (app.request.get('sortDirection') == 'DESC' ? 'ASC' : 'DESC') : 'DESC' %}
                    {% set _column_label = metadata.label|trans(_trans_parameters) %}
                    {% set _column_icon = isSortingField ? (nextSortDirection == 'DESC' ? 'fa-arrow-up' : 'fa-arrow-down') : 'fa-sort' %}

                    <th class="{{ isSortingField ? 'sorted' }} {{ metadata.virtual ? 'virtual' }} {{ metadata.dataType|lower }} {{ metadata.css_class }}" {{ easyadmin_config('design.rtl') ? 'dir="rtl"' }}>
                        {% if metadata.sortable %}
                            <a href="{{ path('easyadmin', _request_parameters|merge({ page: 1, sortField: metadata.property, sortDirection: nextSortDirection })) }}">
                                {{ _column_label|raw }} <i class="fa fa-fw {{ _column_icon }}"></i>
                            </a>
                        {% else %}
                            <span>{{ _column_label|raw }}</span>
                        {% endif %}
                    </th>
                {% endfor %}

                {% if _list_item_actions|length > 0 %}
                    <th {% if _entity_config.list.collapse_actions %}width="10px"{% endif %} {{ easyadmin_config('design.rtl') ? 'dir="rtl"' }}>
                        <span class="sr-only">{{ 'list.row_actions'|trans(_trans_parameters, 'EasyAdminBundle') }}</span>
                    </th>
                {% endif %}
            </tr>
        {% endblock table_head %}
        </thead>
        {% set summaryData = {
            "subTotalNetPrice": 0,
            "subTotalRackPrice": 0,
            "commission": 0,
            "tax": 0,
            "profit": 0
        } %}
        <tbody>
        {# {% block table_body %} #}
        {% for item in paginator.currentPageResults %}
            {# @var item \App\Wicrew\SaleBundle\Entity\OrderItem #}
            {% if not easyadmin_is_granted(_entity_config.list.item_permission, item) %}
                {% set _number_of_hidden_results = _number_of_hidden_results + 1 %}
            {% else %}
                {# the empty string concatenation is needed when the primary key is an object (e.g. an Uuid object) #}
                {% set _item_id = '' ~ attribute(item, _entity_config.primary_key_field_name) %}
                <tr data-id="{{ _item_id }}">
                    {% if _has_batch_actions %}
                        <td><input type="checkbox" class="form-batch-checkbox" value="{{ _item_id }}"></td>
                    {% endif %}

                    {% for field, metadata in _fields_visible_by_user %}
                        {% set isSortingField = metadata.property == app.request.get('sortField') %}
                        {% set _column_label =  (metadata.label ?: field|humanize)|trans(_trans_parameters) %}

                        <td class="{{ isSortingField ? 'sorted' }} {{ metadata.dataType|lower }} {{ metadata.css_class }}" {{ easyadmin_config('design.rtl') ? 'dir="rtl"' }}>
                            {% if field in summaryData|keys %}
                                {% set value = 1 %}

                                {% if field == 'subTotalNet' %}
                                    {% set value = item.subTotalNet %}
                                    {% set displayValue = value %}
                                {% elseif field == 'subTotalRackPrice' %}
                                    {% set value = item.subTotalRack %}
                                    {% set displayValue = value %}
                                {% elseif field == 'commission' %}
                                    {% if item.order.supplier is not null %}
                                        {% set commissionValue = (item.subtotalRack * (item.order.supplier.commission / 100)) %}
                                        {% set value = commissionValue %}
                                        {% set displayValue = commissionValue ~ '(' ~ item.order.supplier.commission ~ '%)' %}
                                    {% else %}
                                        {% set value = 0 %}
                                        {% set displayValue = '<span class="badge badge-secondary">Null</span>' %}
                                    {% endif %}
                                {% elseif field == 'tax' %}
                                    {% set value = item.totalTax %}
                                    {% set displayValue = value %}
                                {% elseif field == 'profit' %}
                                    {% set rackPrice = item.subTotalRack %}
                                    {% set netPrice = item.subTotalNet %}

                                    {% if item.order.supplier is not null %}
                                        {% set commission = (rackPrice * (item.order.supplier.commission / 100)) %}
                                    {% else %}
                                        {% set commission = 0 %}
                                    {% endif %}

                                    {% set value = (rackPrice - netPrice - commission) %}
                                    {% set displayValue = value %}
                                {% endif %}

                                {{ displayValue|raw }}

                                {% set summaryData = summaryData|merge({(field): (summaryData[field] + value)}) %}
                            {% else %}
                                {{ easyadmin_render_field_for_list_view(_entity_config.name, item, metadata) }}
                            {% endif %}
                        </td>
                    {% endfor %}

                    {% if _list_item_actions|length > 0 %}
                        {% set _column_label =  'list.row_actions'|trans(_trans_parameters, 'EasyAdminBundle') %}
                        <td class="actions">
                            {% block item_actions %}
                                {% set _actions_template = _entity_config.list.collapse_actions
                                    ? '@EasyAdmin/default/includes/_actions_dropdown.html.twig'
                                    : '@EasyAdmin/default/includes/_actions.html.twig' %}
                                {{ include(_actions_template, {
                                    actions: _list_item_actions,
                                    entity_config: _entity_config,
                                    request_parameters: _request_parameters,
                                    translation_domain: _entity_config.translation_domain,
                                    trans_parameters: _trans_parameters,
                                    item_id: _item_id,
                                    item: item
                                }, with_context = false) }}
                            {% endblock item_actions %}
                        </td>
                    {% endif %}
                </tr>
            {% endif %}
        {% else %}
            <tr>
                <td class="no-results" colspan="{{ _fields_visible_by_user|length + 1 }}">
                    {{ 'search.no_results'|trans(_trans_parameters, 'EasyAdminBundle') }}
                </td>
            </tr>
        {% endfor %}

        {% if _number_of_hidden_results > 0 %}
            <tr class="datagrid-row-empty">
                <td class="text-center" colspan="{{ _fields_visible_by_user|length + 1 }}">
                    <span class="datagrid-row-empty-message"><i
                                class="fa fa-lock mr-1"></i> {{ 'security.list.hidden_results'|trans({}, 'EasyAdminBundle') }}</span>
                </td>
            </tr>
        {% endif %}
        {# {% endblock table_body %} #}
        </tbody>
        {% if paginator.currentPageResults|length > 0 %}
            <tfoot>
            <tr>
                {% if _has_batch_actions %}
                    <td>&nbsp;</td>
                {% endif %}
                {% for field, metadata in _fields_visible_by_user %}
                    <td class="{% if field in summaryData|keys %}text-right{% endif %}">
                        <strong>
                            {% if loop.index0 == 0 %}
                                {{ 'report.total'|trans }}
                            {% elseif field in summaryData|keys %}
                                {{ summaryData[field] }}
                            {% else %}
                                &nbsp;
                            {% endif %}
                        </strong>
                    </td>
                {% endfor %}
            </tr>
            </tfoot>
        {% endif %}
    </table>

    {% block delete_form %}
        {% set referer = paginator.currentPage == paginator.nbPages and 1 != paginator.currentPage and 1 == paginator.currentPageResults|length
            ? path('easyadmin', app.request.query|merge({ page: app.request.query.get('page') - 1 }))
            : app.request.requestUri %}

        {{ include('@EasyAdmin/default/includes/_delete_form.html.twig', {
            view: 'list',
            referer: referer,
            delete_form: delete_form_template,
            _translation_domain: _entity_config.translation_domain,
            _trans_parameters: _trans_parameters,
            _entity_config: _entity_config,
        }, with_context = false) }}
    {% endblock delete_form %}
{% endblock main %}

{% block content_footer %}
    {% block paginator %}
        {# {{ include(_entity_config.templates.paginator) }} #}
    {% endblock paginator %}
{% endblock %}